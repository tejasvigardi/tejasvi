<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blood Bank Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 1200px;
      margin: auto;
    }
    .header {
      background-color: #800000;
      color: white;
      text-align: center;
      padding: 10px;
      border-radius: 5px 5px 0 0;
      margin-bottom: 20px;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
    }
    .card {
      background-color: white;
      border-radius: 5px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .card h2 {
      color: #800000;
      margin-top: 0;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #333;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #800000;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }
    button:hover {
      background-color: #a52a2a;
    }
    #currentStock {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    #incomingRequests {
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #b30000;
      color: white;
    }
    .action-btn {
      width: auto;
      padding: 6px 10px;
      margin: 0 4px;
      background: #2e7d32;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
    }
    .action-btn.reject { background: #c62828; }
    tr:hover {
      background: #f5f5f5;
    }
    .accepted { background: #d4edda; }
    .rejected { background: #f8d7da; }
    .placeholder {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    .message {
      text-align: center;
      color: #b30000;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      background: #fff5f5;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <h1 style="margin:0;">Welcome Blood Bank</h1>
        <div>
          <button onclick="logout()" style="padding:8px 12px; border-radius:8px; border:none; background:#fff; color:#800; cursor:pointer;">Logout</button>
        </div>
      </div>
    </div>
    <div class="dashboard-grid">
      <!-- Update Blood Inventory -->
      <div class="card">
        <h2>Update Blood Inventory</h2>
        <form id="inventoryForm">
          <div class="form-group">
            <label>Blood Group:</label>
            <select name="blood_group" required>
              <option value="">Select Blood Group</option>
              <option value="A+">A+</option>
              <option value="A-">A-</option>
              <option value="B+">B+</option>
              <option value="B-">B-</option>
              <option value="AB+">AB+</option>
              <option value="AB-">AB-</option>
              <option value="O+">O+</option>
              <option value="O-">O-</option>
            </select>
          </div>
          <div class="form-group">
            <label>Units Available:</label>
            <input type="number" name="units" placeholder="Enter number of units" min="0" required />
          </div>
          <div class="form-group">
            <label>Last Updated:</label>
            <input type="date" name="last_updated" value="dd/mm/yyyy" required />
          </div>
          <button type="submit">Update Inventory</button>
        </form>
      </div>

      <!-- Current Stock -->
      <div class="card">
        <h2>Current Stock</h2>
        <div id="currentStock">
          <table id="inventoryTable">
            <thead>
              <tr><th>Blood Group</th><th>Units</th><th>Last Updated</th></tr>
            </thead>
            <tbody id="inventoryBody">
              <tr><td colspan="3" class="placeholder">Loading inventory...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Incoming Blood Requests -->
      <div class="card">
        <h2>Incoming Blood Requests</h2>
        <div id="requestMessage" class="message"></div>
        <div id="incomingRequests">
          <table id="requestTable">
            <thead>
              <tr>
                <th>Receiver</th>
                <th>Recipient</th>
                <th>Blood Group</th>
                <th>Message</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="requestList">
              <tr><td colspan="6" class="placeholder">No requests found.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Helper to show a message in the requestMessage box
    function showMessage(msg) {
      const box = document.getElementById('requestMessage');
      if (!box) return;
      box.textContent = msg;
      box.style.display = 'block';
      setTimeout(() => { box.style.display = 'none'; }, 3500);
    }
    // Read logged-in user from localStorage (saved by login page)
    function getCurrentUser() {
      try { return JSON.parse(localStorage.getItem('user')) || null; } catch (e) { return null; }
    }

    const currentUser = getCurrentUser();
    const bloodBankId = currentUser?._id || null;
    console.log("bloodBankId:", bloodBankId); // Debug log
    if (!bloodBankId) {
      showMessage("Please log in to update inventory.");
      window.location.href = "login.html";
      throw new Error("No bloodBankId");
    }

    // Update Inventory
    document.getElementById("inventoryForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const blood_group = this.blood_group.value;
      const units = this.units.value;
      const last_updated = this.last_updated.value;

      try {
        const response = await fetch("http://localhost:5000/api/inventory", {
          method: "POST",
          headers: { "Content-Type": "application/json", 'x-user-id': bloodBankId },
          body: JSON.stringify({ blood_bank_id: bloodBankId, blood_group, units, last_updated })
        });
        const result = await response.json();
        if (response.ok) {
          showMessage(result.message);
          fetchInventory();
        } else {
          showMessage(`Error: ${result.error || "Unknown error"}`);
        }
      } catch (err) {
        console.error("Error updating inventory:", err);
        showMessage("Error updating inventory. Check server connection.");
      }
    });

    // Fetch Inventory
    async function fetchInventory() {
      try {
    const response = await fetch(`http://localhost:5000/api/inventory?blood_bank_id=${bloodBankId}`, { headers: { 'x-user-id': bloodBankId } });
          const inventory = await response.json();
          const body = document.getElementById('inventoryBody');
          body.innerHTML = '';
          if (response.ok && inventory.length > 0) {
            inventory.forEach(item => {
              const tr = document.createElement('tr');
              const gTd = document.createElement('td'); gTd.textContent = item.blood_group;
              const uTd = document.createElement('td'); uTd.textContent = item.units;
              const dTd = document.createElement('td'); dTd.textContent = item.last_updated ? new Date(item.last_updated).toLocaleString() : '-';
              tr.appendChild(gTd); tr.appendChild(uTd); tr.appendChild(dTd);
              body.appendChild(tr);
            });
          } else {
            body.innerHTML = '<tr><td colspan="3" class="placeholder">No inventory available.</td></tr>';
          }
        } catch (err) {
          console.error("Error fetching inventory:", err);
          document.getElementById('inventoryBody').innerHTML = '<tr><td colspan="3" class="placeholder">Error loading inventory.</td></tr>';
        }
    }

    // Fetch Blood Requests
    async function fetchRequests() {
  try {
    const requestList = document.getElementById("requestList");
    requestList.innerHTML = '<tr><td colspan="5" class="placeholder">Loading requests...</td></tr>';

  const response = await fetch(`http://localhost:5000/api/blood-requests?target_id=${encodeURIComponent(bloodBankId)}&target_type=blood_bank`, { headers: { 'x-user-id': bloodBankId } });
    console.log("API Response Status:", response.status); // Debug
    const requests = await response.json();
    console.log("API Response Data:", requests); // Debug
    requestList.innerHTML = '';

    if (response.ok && requests.length > 0) {
      requests.forEach(request => {
        console.log("Processing request:", request); // Debug
        const row = document.createElement('tr');
        const state = (request.status || '').toLowerCase();
        row.className = state === 'accepted' ? 'accepted' : state === 'rejected' ? 'rejected' : '';

        // Create cells
  const receiverCell = document.createElement('td'); receiverCell.textContent = request.receiver || request.receiver_name || 'Unknown';
        const recipientCell = document.createElement('td'); recipientCell.textContent = request.recipient;
        const bgCell = document.createElement('td'); bgCell.textContent = request.bloodGroup;
        const msgCell = document.createElement('td'); msgCell.textContent = request.message || '-';
        const statusCell = document.createElement('td'); statusCell.textContent = request.status || 'Pending';

        row.appendChild(receiverCell);
        row.appendChild(recipientCell);
        row.appendChild(bgCell);
        row.appendChild(msgCell);
        row.appendChild(statusCell);

        // If pending and this blood bank is the target, show Accept/Reject actions
        if (state === 'pending') {
          const actionTd = document.createElement('td');
          const acceptBtn = document.createElement('button');
          acceptBtn.textContent = 'Accept';
          acceptBtn.className = 'action-btn accept';
          const rejectBtn = document.createElement('button');
          rejectBtn.textContent = 'Reject';
          rejectBtn.className = 'action-btn reject';

          // Wire up handlers with DOM references for optimistic updates
          acceptBtn.onclick = () => handleUpdate(request.id, 'Accepted', statusCell, acceptBtn, rejectBtn);
          rejectBtn.onclick = () => handleUpdate(request.id, 'Rejected', statusCell, acceptBtn, rejectBtn);

          actionTd.appendChild(acceptBtn);
          actionTd.appendChild(rejectBtn);
          row.appendChild(actionTd);
        } else {
          // placeholder for action column to keep table layout
          const emptyTd = document.createElement('td'); emptyTd.textContent = '';
          row.appendChild(emptyTd);
        }

        requestList.appendChild(row);
      });
    } else {
      requestList.innerHTML = '<tr><td colspan="6" class="placeholder">No requests found.</td></tr>';
    }
  } catch (err) {
    console.error("Error fetching requests:", err);
    showMessage("Error fetching requests. Please try again.");
    document.getElementById("requestList").innerHTML = '<tr><td colspan="5" class="placeholder">Error fetching requests.</td></tr>';
  }
}

// Handle status updates from blood bank
async function handleUpdate(requestId, newStatus, statusCell = null, acceptBtn = null, rejectBtn = null) {
  // Disable buttons if provided
  if (acceptBtn) acceptBtn.disabled = true;
  if (rejectBtn) rejectBtn.disabled = true;

  // Optimistically update status cell
  const previousStatus = statusCell ? statusCell.textContent : null;
  if (statusCell) statusCell.textContent = newStatus;

  try {
    const res = await fetch(`http://localhost:5000/api/blood-requests/${requestId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'x-user-id': bloodBankId },
      body: JSON.stringify({ status: newStatus })
    });
    const result = await res.json();
    if (res.ok) {
      showMessage(result.message || 'Updated');
      // refresh requests and inventory
      fetchRequests();
      fetchInventory();
    } else {
      // revert optimistic update
      if (statusCell && previousStatus !== null) statusCell.textContent = previousStatus;
      showMessage(result.error || 'Failed to update request');
      if (acceptBtn) acceptBtn.disabled = false;
      if (rejectBtn) rejectBtn.disabled = false;
    }
  } catch (err) {
    console.error('Error updating request:', err);
    if (statusCell && previousStatus !== null) statusCell.textContent = previousStatus;
    showMessage('Error updating request');
    if (acceptBtn) acceptBtn.disabled = false;
    if (rejectBtn) rejectBtn.disabled = false;
  }
}


    // Initialize
    fetchInventory();
    fetchRequests();
    function logout() { try { localStorage.removeItem('user'); } catch (e){}; window.location.href = 'login.html'; }
  </script>
</body>
</html>